(function(){var curIndex;var curSiteIndex;var siteWid;var userUid='';var userJwt='';var ajaxHost='http://ilxdh.com';var tmpData={};if(!!localStorage.getItem('uid')&&!!localStorage.getItem('jwt')){userUid=localStorage.getItem('uid');userJwt=localStorage.getItem('jwt')}var userDialog={showContent:function(){curIndex=layer.open({type:1,title:'添加自定义网站',area:['350px'],content:'<div class="add-site-window clearfix"><div class="add-site-info"><span>网站名称：</span><input type="text" id="diysite-name"/><br><span>网站地址：</span><input type="text" id="diysite-address"/></div><div class="diysite-address-info"><p>如：http://www.baidu.com/</p></div><div class="add-confirm-btn clearfix"><div class="ok-btn1">确定</div><div class="cancel-btn1">取消</div></div></div>'})},modifyContent:function(siteName,siteAddress){curIndex=layer.open({type:1,title:'修改网站',area:['350px'],content:'<div class="add-site-window clearfix"><div class="add-site-info"><span>网站名称：</span><input type="text" id="diysite-name" value="'+siteName+'"/><br><span>网站地址：</span><input type="text" id="diysite-address" value="'+siteAddress+'"/></div><div class="add-confirm-btn clearfix"><div class="modify-ok-btn">确定</div><div class="cancel-btn1">取消</div></div></div>'})},deleteSiteDia:function(curSiteIndex){layer.confirm('确定要删除网站？',{icon:3,title:'提示'},function(index){var curCid=$('#user-diydata').find('.small-cat').find('li.current').attr('sign');var curShowLis=$('#user-diydata').find('.lx-sites-details').find('.show').find('li');var wids=[];for(var i=0;i<curShowLis.length;i+=1){var curWebWid=curShowLis.eq(i).find('a').attr('wid');wids.push(curWebWid)}removeByValue(wids,siteWid);var ids=wids.join(',');var loadIndex=layer.load();$.ajax({url:ajaxHost+'/web/delete',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'cid':curCid,'wid':siteWid,'ids':ids},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);$('#user-diydata').find('.show').find('li').eq(curSiteIndex).remove();layer.close(index)}},error:function(xhr){layer.close(loadIndex);layer.msg('请求失败，请稍后再试！')}})})},deleteCatDia:function(curCatSign,curCatName){layer.confirm('“'+curCatName+'”分类下所有自定义网站将会被删除！确定要删除这个小分类吗？',{icon:3,title:'提示'},function(index){var smallCat=$('#user-diydata').find('.small-cat');var curCid=curCatSign;var curShowLis=$('#user-diydata').find('.lx-sites-details').find('.show').find('li');var wids=[];for(var i=0;i<curShowLis.length;i+=1){var curWebWid=curShowLis.eq(i).find('a').attr('wid');wids.push(curWebWid)}var ids=wids.join(',');var loadIndex=layer.load();$.ajax({url:ajaxHost+'/category/delete',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'cid':curCid,'ids':ids},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);smallCat.find('[sign="'+curCatSign+'"]').remove();$('#user-diydata').find('.lx-sites-details').find('[sign="'+curCatSign+'"]').remove();smallCat.find('.item').eq(0).trigger('click');setTabHeight();layer.close(index)}},error:function(xhr){layer.close(loadIndex);layer.msg('请求失败，请稍后再试！')}})})},addSmallCat:function(){curIndex=layer.open({type:1,title:'添加小分类',area:['350px'],content:'<div class="add-site-window clearfix"><div class="add-site-info"><span>分类名称：</span><input type="text" id="diysite-name"/></div><div class="add-confirm-btn clearfix"><div class="addcat-ok-btn">确定</div><div class="cancel-btn1">取消</div></div></div>'})},modifyCat:function(siteName){curIndex=layer.open({type:1,title:'修改小分类',area:['350px'],content:'<div class="add-site-window clearfix"><div class="add-site-info"><span>分类名称：</span><input type="text" id="diysite-name" value="'+siteName+'"/></div><div class="add-confirm-btn clearfix"><div class="modifycat-ok-btn">确定</div><div class="cancel-btn1">取消</div></div></div>'})}};function removeByValue(arr,val){for(var i=0;i<arr.length;i+=1){if(arr[i]==val){arr.splice(i,1);break}}}function judgeLogin(){if(!!localStorage.getItem('uid')&&!!localStorage.getItem('jwt')){return true}else{return false}}function qqLogin(){var redirectURI=encodeURI(''+ajaxHost+'/auth/qq');var url="https://graph.qq.com/oauth2.0/authorize?response_type=code&client_id=101421330&redirect_uri="+redirectURI+"&scope=get_user_info";window.open(url,"龙轩导航登录","width=780,height=470,menubar=0,scrollbars=1,resizable=1,status=1,titlebar=0,toolbar=0,location=1")}function setTabHeight(){var curBigCat=$('#user-diydata').find('.big-cat');var smallCatH=curBigCat.next('.small-cat').height();curBigCat.height(smallCatH).find('span').css({'height':(smallCatH+1)+'px','line-height':(smallCatH+1)+'px'})}function showLoginInfo(){var topright=$('.top-right');topright.find('.login').hide();topright.find('.loginInfo').show();topright.find('.logout').show()}function hideLoginInfo(){var topright=$('.top-right');topright.find('.login').show();topright.find('.loginInfo').hide();topright.find('.logout').hide()}var Userdiy=function(){this.userDiydata=$('#user-diydata');this.lxSitesDetails=this.userDiydata.find('.lx-sites-details');this.editSettings=$('.edit-settings');this.editCancel=$('.edit-cancel');this.sortState=$('.sort-state');this.modifyState=$('.modify-state');this.addSite=$('.add-site');this.addCategory=$('.add-category');this.diyTabUl=this.userDiydata.find('.tab').find('ul');this.userDiySitesContent=this.userDiydata.find('.sites-content');this.bianjiMode=false;this.xiugaiStatus=false;this.paixuStatus=false;this.curCatIndex;this.catSign;this.paixudrag;this.paixuCatDrag;this.regSite=/(https?|ftp|file):\/\/[-A-Za-z0-9+&@#\/\%?=~_|!:,.;]+[-A-Za-z0-9+&@#\/\%=~_|]/;this.init()};Userdiy.prototype={init:function(){this.judgeLoginAndExpire();this.bindEvents()},judgeLoginAndExpire:function(){var that=this;if(!!userUid&&!!userJwt){$.ajax({url:ajaxHost+'/content',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},success:function(data){if(data['e']==8888){localStorage.removeItem('uid');localStorage.removeItem('jwt');localStorage.removeItem('nickyname');localStorage.removeItem('head_url')}if(data['c']===200){showLoginInfo();$('.top-right').find('.loginInfo').find('p').html('欢迎您，'+localStorage.getItem('nickyname')+'');that.zzData()}},error:function(xhr){console.log('请求失败，请稍后再试！')}})}},zzData:function(){var that=this;$.ajax({url:ajaxHost+'/content',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},success:function(data){if(data['c']===200){var websData=data['d']['webs'];var categoryData=data['d']['categorys'];tmpData['categorys']=categoryData;for(var i=0;i<websData.length;i+=1){var curcid=websData[i]['cid'];var curwid=websData[i]['wid'];var curtitle=websData[i]['title'];var cururl=websData[i]['url'];if(!tmpData[curcid]){tmpData[curcid]=[{'cid':curcid,'wid':curwid,'title':curtitle,'url':cururl}]}else{tmpData[curcid].push({'cid':curcid,'wid':curwid,'title':curtitle,'url':cururl})}}that.renderFirstPage(tmpData)}},error:function(xhr){}})},renderFirstPage:function(data){var tmpCatHtml='';var tmpWebsHtml='';var categoryData=tmpData['categorys'];for(var i=0;i<categoryData.length;i+=1){var curCatTitle=categoryData[i]['title'];var curCatCid=categoryData[i]['cid'];tmpCatHtml+='<li class="item" sign="'+curCatCid+'"><span class="delete-cat"></span><span>'+curCatTitle+'</span><span class="edit-cat"></span></li>'}$('#user-diydata').find('.small-cat').find('ul').html(tmpCatHtml);for(var i in tmpData){var curtmpWebsHtml='';if(i!='categorys'){for(var j=0;j<tmpData[i].length;j+=1){var tmpWebcid=tmpData[i][j]['cid'];var tmpWebwid=tmpData[i][j]['wid'];var tmpWebtitle=tmpData[i][j]['title'];var tmpWeburl=tmpData[i][j]['url'];curtmpWebsHtml+='<li><a wid="'+tmpWebwid+'" href="'+tmpWeburl+'" target="_blank" title="'+tmpWebtitle+'">'+tmpWebtitle+'</a><span class="edit-site"></span><span class="delete-site"></span></li>'}tmpWebsHtml+='<div class="content-container" sign="'+tmpWebcid+'"><div class="sites-content"><ul class="clearfix">'+curtmpWebsHtml+'</ul></div></div>'}}$('#user-diydata').find('.lx-sites-details').html(tmpWebsHtml);setTabHeight();$('#user-diydata').find('.small-cat').find('li').eq(0).trigger('click')},bindEvents:function(){var that=this;$('.top-right').on('click','.login',function(){if(!!window.localStorage){qqLogin()}else{alert('您的浏览器不支持localStorage，请升级浏览器。')}});$('.top-right').on('click','.logout',function(){localStorage.removeItem('uid');localStorage.removeItem('jwt');localStorage.removeItem('nickyname');localStorage.removeItem('head_url');window.location.reload()});this.addSite.on('click',function(){$(this).addClass('active').siblings('span').removeClass('active');that.exitPaixuMode();that.exitXiugaiMode();userDialog.showContent()});this.modifyState.on('click',function(){if(!that.xiugaiStatus){$(this).addClass('active').siblings('span').removeClass('active');that.helloXiugaiMode()}else{$(this).removeClass('active').siblings('span').removeClass('active');that.exitXiugaiMode();layer.msg('已退出修改模式！',{time:1300})}});this.userDiydata.on('click','.edit-site',function(){var $this=$(this);var siteInfo=$this.prev();curSiteIndex=$this.parent().index();var siteAddress=siteInfo.attr('href');var siteName=siteInfo.text();siteWid=siteInfo.attr('wid');userDialog.modifyContent(siteName,siteAddress,siteWid)});this.userDiydata.on('click','.delete-site',function(){var $this=$(this);var siteInfo=$this.prev().prev();var hahacurSiteIndex=$this.parent().index();siteWid=siteInfo.attr('wid');userDialog.deleteSiteDia(hahacurSiteIndex)});this.userDiydata.on('click','.edit-cat',function(){var $this=$(this);var siteInfo=$this.prev();var catName=siteInfo.text();that.catSign=$(this).parent().attr('sign');userDialog.modifyCat(catName)});this.userDiydata.on('click','.delete-cat',function(){var $this=$(this);var hahacurCatSign=$this.parent().attr('sign');var curCatName=$this.next().text();if(that.diyTabUl.find('.item').length>1){userDialog.deleteCatDia(hahacurCatSign,curCatName)}else{layer.alert('最少需要一个小分类，无法删除！',{icon:2,shadeClose:true})}});$(document).on('click','.cancel-btn1',function(){layer.close(curIndex)});$(document).on('click','.ok-btn1',function(){var returnVal=that.judgeSiteInfo();if(returnVal=='1'){layer.msg('填入的值不能为空',{icon:2,time:1200})}else if(returnVal=='2'){layer.msg('网址不符合规范',{icon:2,time:1200})}else if(returnVal=='yes'){if(that.lxSitesDetails.find('.show').find('li').length>=60){layer.alert('添加失败，每个分类最多添加60个网站！',{icon:2,shadeClose:true})}else{var siteName=that.trimKG($('#diysite-name').val());var siteAddress=that.trimKG($('#diysite-address').val());var curCid=that.userDiydata.find('.small-cat').find('li.current').attr('sign');var loadIndex=layer.load();$.ajax({url:ajaxHost+'/web/add',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'title':siteName,'cid':curCid,'url':siteAddress},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);that.lxSitesDetails.find('.show').find('ul').append('<li><a wid="'+data['d']['wid']+'" href="'+siteAddress+'" target="_blank" title="'+siteName+'">'+siteName+'</a><span class="edit-site"></span><span class="delete-site"></span></li>');layer.close(curIndex)}},error:function(xhr){layer.close(loadIndex);layer.msg('操作失败，请稍后再试！')}})}if(!!that.paixuStatus){that.paixudrag.deactivate();that.paixuStatus=false}}});$(document).on('click','.modify-ok-btn',function(){var returnVal=that.judgeSiteInfo();if(returnVal=='1'){layer.msg('填入的值不能为空',{icon:2,time:1200})}else if(returnVal=='2'){layer.msg('网址格式错误',{icon:2,time:1200})}else if(returnVal=='yes'){var siteName=that.trimKG($('#diysite-name').val());var siteAddress=that.trimKG($('#diysite-address').val());var curCid=that.userDiydata.find('.small-cat').find('li.current').attr('sign');var loadIndex=layer.load();$.ajax({url:ajaxHost+'/web/update',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'title':siteName,'cid':curCid,'url':siteAddress,'wid':siteWid},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);var $curEditSite=that.userDiydata.find('.show').find('li').eq(curSiteIndex).find('a');$curEditSite.attr('href',siteAddress).text(siteName);if(!!$curEditSite.hasClass('dads-children')){$curEditSite.removeClass('dads-children')}layer.close(curIndex)}},error:function(xhr){layer.close(loadIndex);alert('修改失败，请稍后再试！')}})}});$(document).on('click','.addcat-ok-btn',function(){var returnVal=that.judgeSiteInfo();if(returnVal=='1'){layer.msg('填入的值不能为空',{icon:2,time:1200})}else if(returnVal=='yes'){var curSmallCat=that.userDiydata.find('.small-cat');if(curSmallCat.find('.item').length>=20){layer.alert('添加失败，最多添加20个分类！',{icon:2,shadeClose:true})}else{var catName=that.trimKG($('#diysite-name').val());var loadIndex=layer.load();$.ajax({url:ajaxHost+'/category/add',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'title':catName},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);curSmallCat.find('ul').append('<li class="item" sign="'+data['d']['id']+'"><span class="delete-cat"></span><span>'+catName+'</span><span class="edit-cat"></span></li>');var tempHtml='<div class="content-container" sign="'+data['d']['id']+'"><div class="sites-content"><ul class="clearfix"></ul></div></div>';that.lxSitesDetails.append(tempHtml);setTabHeight();layer.close(curIndex)}},error:function(xhr){layer.close(loadIndex);layer.msg('请求失败，请稍后再试！')}})}}});$(document).on('click','.modifycat-ok-btn',function(){var returnVal=that.judgeSiteInfo();if(returnVal=='1'){layer.msg('填入的值不能为空',{icon:2,time:1200})}else if(returnVal=='2'){layer.msg('网址不符合规范',{icon:2,time:1200})}else if(returnVal=='yes'){var catName=that.trimKG($('#diysite-name').val());var curCid=that.userDiydata.find('.small-cat').find('li.current').attr('sign');var loadIndex=layer.load();$.ajax({url:ajaxHost+'/category/update',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'title':catName,'cid':curCid},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);var $curEditCat=that.userDiydata.find('.small-cat').find('[sign="'+curCid+'"]');var $curSpan=$curEditCat.find('span').eq(1);$curSpan.text(catName);if(!!$curSpan.hasClass('dads-children')){$curSpan.removeClass('dads-children')}layer.close(curIndex)}},error:function(xhr){layer.close(loadIndex);alert('修改失败，请稍后再试！')}})}});this.sortState.on('click',function(){var $this=$(this);that.exitXiugaiMode();if(!that.paixuStatus){$this.html('保存排序');that.modifyState.hide();that.addSite.hide();that.addCategory.hide();that.editCancel.html('取消');$this.addClass('active').siblings('span').removeClass('active');that.paixuStatus=true;that.userDiydata.find('.show').find('a').addClass('move');that.userDiydata.find('.small-cat').find('.item').addClass('move');that.paixudrag=that.lxSitesDetails.find('.show').find('ul').dad({'target':'li','placeholder':'放在这里'});that.paixuCatDrag=that.userDiydata.find('.small-cat').find('ul').dad({'target':'.item','placeholder':'放在这里'});layer.msg('已进入排序模式，拖动排序即可...',{time:1800})}else{var curCid=that.userDiydata.find('.small-cat').find('li.current').attr('sign');var curSmallTabs=that.userDiydata.find('.small-cat').find('.item');var catIds=[];for(var i=0;i<curSmallTabs.length;i+=1){var curCatId=curSmallTabs.eq(i).attr('sign');catIds.push(curCatId)}var cids=catIds.join(',');var curWebLis=that.lxSitesDetails.find('.show').find('li');var webIds=[];for(var i=0;i<curWebLis.length;i+=1){var curWebId=curWebLis.eq(i).find('a').attr('wid');webIds.push(curWebId)}var wids=webIds.join(',');var loadIndex=layer.load();$.ajax({url:ajaxHost+'/web/queue',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'ids':wids,'cid':curCid},success:function(data){if(data['c']===1){layer.msg(data['em'])}if(data['c']===200){$.ajax({url:ajaxHost+'/category/queue',type:"POST",dataType:'json',headers:{'Uid':userUid,'Jwt':userJwt},data:{'ids':cids},success:function(data){if(data['c']===1){layer.close(loadIndex);layer.msg(data['em'])}if(data['c']===200){layer.close(loadIndex);$this.html('排序');that.editCancel.html('完成');that.modifyState.show();that.addSite.show();that.addCategory.show();that.editCancel.show();$this.removeClass('active').siblings('span').removeClass('active');that.exitPaixuMode();layer.msg('排序成功！',{time:1400})}},error:function(xhr){layer.close(loadIndex);layer.msg('请求失败，请稍后再试！')}})}},error:function(xhr){layer.msg('请求失败，请稍后再试！')}})}});this.editCancel.on('click',function(){if(!!judgeLogin()){var $this=$(this);if(!that.bianjiMode){$this.html('完成');that.sortState.show();that.modifyState.show();that.addSite.show();that.addCategory.show();that.bianjiMode=true}else if(that.editCancel.text()==='取消'){$this.html('完成');that.sortState.html('排序').removeClass('active');that.modifyState.show();that.addSite.show();that.addCategory.show();that.editCancel.show();that.exitPaixuMode()}else{$this.siblings('span').removeClass('active');$this.html('编辑');that.sortState.hide();that.modifyState.hide();that.addSite.hide();that.addCategory.hide();that.exitXiugaiMode();that.exitPaixuMode();that.bianjiMode=false}}else{layer.msg('请先登录！',{time:1300})}});this.addCategory.on('click',function(){var $this=$(this);$this.addClass('active').siblings('span').removeClass('active');that.exitPaixuMode();that.exitXiugaiMode();that.curCatIndex=new Date().getTime();userDialog.addSmallCat()});this.diyTabUl.on('click','.item',function(){var $this=$(this);var curSign=$this.attr('sign');$this.addClass('current').siblings().removeClass('current');var showDetailsDivs=that.lxSitesDetails.find('[sign="'+curSign+'"]');if(showDetailsDivs.length>0){showDetailsDivs.addClass('show').siblings().removeClass('show')}else{that.lxSitesDetails.find('.show').removeClass('show');var tempHtml='<div class="content-container show" sign="'+curSign+'"><div class="sites-content"><ul class="clearfix"></ul></div></div>';that.lxSitesDetails.append(tempHtml)}})},judgeSiteInfo:function(){var siteName=$('#diysite-name');var siteAddress=$('#diysite-address');if(siteAddress.length!=0){if(this.trimKG(siteName.val())==''||this.trimKG(siteAddress.val())==''){return '1'}}else{if(this.trimKG(siteName.val())==''){return '1'}}if(siteAddress.length!=0){if(!this.regSite.test(this.trimKG(siteAddress.val()))){return '2'}}return 'yes'},trimKG:function(str){return str.replace(/(^\s*)|(\s*$)/g,"")},helloXiugaiMode:function(){layer.msg('已进入修改模式，请修改...',{time:1300});this.exitPaixuMode();if(!this.xiugaiStatus){this.xiugaiStatus=true;this.disabledAlink();this.showEditSite()}},exitXiugaiMode:function(){if(!!this.xiugaiStatus){this.userDiydata.find('.sites-content').find('a').css('cursor','auto');this.hideEditSite();this.abledAlink();this.xiugaiStatus=false}},exitPaixuMode:function(){if(!!this.paixuStatus){this.paixudrag.deactivate();this.paixuCatDrag.deactivate();this.userDiydata.find('.sites-content').find('a').removeClass('move');this.userDiydata.find('.small-cat').find('.item').removeClass('move');this.paixuStatus=false}},showEditSite:function(){$('.edit-site').addClass('show');$('.delete-site').addClass('show');$('.edit-cat').addClass('show');$('.delete-cat').addClass('show');setTabHeight()},hideEditSite:function(){$('.edit-site').removeClass('show');$('.delete-site').removeClass('show');$('.edit-cat').removeClass('show');$('.delete-cat').removeClass('show');setTabHeight()},disabledAlink:function(){this.userDiydata.find('.sites-content').find('a').css('cursor','text').attr("onclick","return false;")},abledAlink:function(){this.userDiydata.find('.sites-content').find('a').css('cursor','auto').removeAttr("onclick")}};var userdiy=new Userdiy()})();